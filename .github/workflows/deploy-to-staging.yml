name: deploy to production
on:
  push:
    branches:
      - 'staging'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        persist-credentials: false 
        fetch-depth: 0
    - name: Tag Staging Version
      run: |
        echo "Working on branch ${{ github.ref }}"
        git fetch
        git checkout staging
        latest_version=$(git tag | sort -V | tail -1)
        latest_version_major=$(echo $latest_version | cut -c2-2)
        latest_version_minor=$(echo $latest_version | cut -c4-4)
        echo "Latest Version: v${latest_version_major}.${latest_version_minor}"

        let new_version_minor=latest_version_minor+1
        new_version="v${latest_version_major}.${new_version_minor}"
        echo "About to Tag ${new_version}"
        git config --global user.name ${{ secrets.NAME }}
        git config --global user.email ${{ secrets.EMAIL }}
        git tag -a ${new_version} -m ${new_version}
      
    - uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.VANTI_ADMIN_GITHUB_TOKEN }}
        branch: staging
        repository: "hammock-studio/git-flow-example-"
        tags: true

    - name: Run e2e tests
      run: |
        echo "Run e2e tests"

    - name: Deploy To Staging
      run: |
        echo "Invoke ECR + ECS deployment"
